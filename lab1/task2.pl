student(102,'Петров').
student(101,'Петровский').
student(104,'Иванов').
student(102,'Ивановский').
student(104,'Запорожцев').
student(101,'Сидоров').
student(103,'Сидоркин').
student(102,'Биткоинов').
student(103,'Эфиркина').
student(103,'Сиплюсплюсов').
student(103,'Программиро').
student(104,'Джаво').
student(103,'Клавиатурникова').
student(101,'Мышин').
student(104,'Фулл').
student(101,'Безумников').
student(102,'Шарпин').
student(104,'Круглосчиталкин').
student(103,'Решетников').
student(102,'Эксель').
student(102,'Текстописов').
student(103,'Текстописова').
student(101,'Густобуквенникова').
student(102,'Криптовалютников').
student(104,'Блокчейнис').
student(102,'Азурин').
student(103,'Вебсервисов').
student(102,'Круглотличников').
subject('LP','Логическое программирование').
subject('MTH','Математический анализ').
subject('FP','Функциональное программирование').
subject('INF','Информатика').
subject('ENG','Английский язык').
subject('PSY','Психология').
grade('Петров','LP',4).
grade('Петров','MTH',3).
grade('Петров','FP',5).
grade('Петров','INF',4).
grade('Петров','ENG',4).
grade('Петров','PSY',3).
grade('Петровский','LP',5).
grade('Петровский','MTH',5).
grade('Петровский','FP',5).
grade('Петровский','INF',4).
grade('Петровский','ENG',5).
grade('Петровский','PSY',3).
grade('Иванов','LP',5).
grade('Иванов','MTH',3).
grade('Иванов','FP',4).
grade('Иванов','INF',5).
grade('Иванов','ENG',5).
grade('Иванов','PSY',5).
grade('Ивановский','LP',3).
grade('Ивановский','MTH',5).
grade('Ивановский','FP',4).
grade('Ивановский','INF',3).
grade('Ивановский','ENG',5).
grade('Ивановский','PSY',5).
grade('Запорожцев','LP',2).
grade('Запорожцев','MTH',2).
grade('Запорожцев','FP',4).
grade('Запорожцев','INF',3).
grade('Запорожцев','ENG',4).
grade('Запорожцев','PSY',4).
grade('Сидоров','LP',4).
grade('Сидоров','MTH',4).
grade('Сидоров','FP',4).
grade('Сидоров','INF',4).
grade('Сидоров','ENG',3).
grade('Сидоров','PSY',4).
grade('Сидоркин','LP',4).
grade('Сидоркин','MTH',5).
grade('Сидоркин','FP',4).
grade('Сидоркин','INF',3).
grade('Сидоркин','ENG',4).
grade('Сидоркин','PSY',4).
grade('Биткоинов','LP',5).
grade('Биткоинов','MTH',4).
grade('Биткоинов','FP',3).
grade('Биткоинов','INF',4).
grade('Биткоинов','ENG',3).
grade('Биткоинов','PSY',2).
grade('Эфиркина','LP',2).
grade('Эфиркина','MTH',4).
grade('Эфиркина','FP',3).
grade('Эфиркина','INF',2).
grade('Эфиркина','ENG',2).
grade('Эфиркина','PSY',4).
grade('Сиплюсплюсов','LP',4).
grade('Сиплюсплюсов','MTH',4).
grade('Сиплюсплюсов','FP',4).
grade('Сиплюсплюсов','INF',5).
grade('Сиплюсплюсов','ENG',4).
grade('Сиплюсплюсов','PSY',4).
grade('Программиро','LP',5).
grade('Программиро','MTH',4).
grade('Программиро','FP',3).
grade('Программиро','INF',3).
grade('Программиро','ENG',5).
grade('Программиро','PSY',4).
grade('Джаво','LP',4).
grade('Джаво','MTH',4).
grade('Джаво','FP',3).
grade('Джаво','INF',2).
grade('Джаво','ENG',3).
grade('Джаво','PSY',5).
grade('Клавиатурникова','LP',4).
grade('Клавиатурникова','MTH',5).
grade('Клавиатурникова','FP',3).
grade('Клавиатурникова','INF',5).
grade('Клавиатурникова','ENG',4).
grade('Клавиатурникова','PSY',4).
grade('Мышин','LP',5).
grade('Мышин','MTH',4).
grade('Мышин','FP',5).
grade('Мышин','INF',4).
grade('Мышин','ENG',3).
grade('Мышин','PSY',3).
grade('Фулл','LP',4).
grade('Фулл','MTH',4).
grade('Фулл','FP',4).
grade('Фулл','INF',5).
grade('Фулл','ENG',5).
grade('Фулл','PSY',5).
grade('Безумников','LP',3).
grade('Безумников','MTH',5).
grade('Безумников','FP',3).
grade('Безумников','INF',2).
grade('Безумников','ENG',4).
grade('Безумников','PSY',3).
grade('Шарпин','LP',3).
grade('Шарпин','MTH',4).
grade('Шарпин','FP',4).
grade('Шарпин','INF',5).
grade('Шарпин','ENG',5).
grade('Шарпин','PSY',5).
grade('Круглосчиталкин','LP',5).
grade('Круглосчиталкин','MTH',2).
grade('Круглосчиталкин','FP',4).
grade('Круглосчиталкин','INF',3).
grade('Круглосчиталкин','ENG',4).
grade('Круглосчиталкин','PSY',3).
grade('Решетников','LP',4).
grade('Решетников','MTH',4).
grade('Решетников','FP',5).
grade('Решетников','INF',3).
grade('Решетников','ENG',5).
grade('Решетников','PSY',3).
grade('Эксель','LP',4).
grade('Эксель','MTH',4).
grade('Эксель','FP',4).
grade('Эксель','INF',3).
grade('Эксель','ENG',5).
grade('Эксель','PSY',4).
grade('Текстописов','LP',2).
grade('Текстописов','MTH',5).
grade('Текстописов','FP',4).
grade('Текстописов','INF',3).
grade('Текстописов','ENG',5).
grade('Текстописов','PSY',3).
grade('Текстописова','LP',4).
grade('Текстописова','MTH',4).
grade('Текстописова','FP',4).
grade('Текстописова','INF',3).
grade('Текстописова','ENG',5).
grade('Текстописова','PSY',2).
grade('Густобуквенникова','LP',5).
grade('Густобуквенникова','MTH',2).
grade('Густобуквенникова','FP',4).
grade('Густобуквенникова','INF',5).
grade('Густобуквенникова','ENG',4).
grade('Густобуквенникова','PSY',3).
grade('Криптовалютников','LP',5).
grade('Криптовалютников','MTH',2).
grade('Криптовалютников','FP',2).
grade('Криптовалютников','INF',3).
grade('Криптовалютников','ENG',4).
grade('Криптовалютников','PSY',2).
grade('Блокчейнис','LP',5).
grade('Блокчейнис','MTH',2).
grade('Блокчейнис','FP',5).
grade('Блокчейнис','INF',3).
grade('Блокчейнис','ENG',4).
grade('Блокчейнис','PSY',5).
grade('Азурин','LP',4).
grade('Азурин','MTH',2).
grade('Азурин','FP',4).
grade('Азурин','INF',3).
grade('Азурин','ENG',5).
grade('Азурин','PSY',2).
grade('Вебсервисов','LP',3).
grade('Вебсервисов','MTH',4).
grade('Вебсервисов','FP',3).
grade('Вебсервисов','INF',3).
grade('Вебсервисов','ENG',5).
grade('Вебсервисов','PSY',2).
grade('Круглотличников','LP',4).
grade('Круглотличников','MTH',3).
grade('Круглотличников','FP',5).
grade('Круглотличников','INF',5).
grade('Круглотличников','ENG',3).
grade('Круглотличников','PSY',5).


% 1. Получить таблицу групп и средний балл по каждой из групп

student_total_grades(Student, Total) :-
    findall(Grade, grade(Student, _, Grade), Grades),
    sum_list(Grades, Total).

student_subjects_count(Student, Count) :-
    findall(Subj, grade(Student, Subj, _), Subjects),
    length(Subjects, Count).

student_average(Student, Average) :-
    student_total_grades(Student, Total),
    student_subjects_count(Student, Count),
    Count > 0,
    Average is Total / Count.

group_average(Group, Average) :-
    findall(Grade, (student(Group, Student), grade(Student, _, Grade)), AllGrades),
    length(AllGrades, Count),
    Count > 0,
    sum_list(AllGrades, Total),
    Average is Total / Count.

groups_averages_table :-
    group_average(101, Avg1),
    group_average(102, Avg2), 
    group_average(103, Avg3),
    group_average(104, Avg4),
    write('Группа 101: '), write(Avg1), nl,
    write('Группа 102: '), write(Avg2), nl,
    write('Группа 103: '), write(Avg3), nl,
    write('Группа 104: '), write(Avg4), nl.

% 2. Для каждого предмета получить список студентов, не сдавших экзамен (grade=2)
failed_students_per_subject(SubjectCode, FailedList) :-
    findall(Student, 
            (grade(Student, SubjectCode, Grade), Grade =:= 2), 
            FailedList).

failed_students_table :-
    write('Предмет | Не сдали'), nl,
    write('-------------------'), nl,
    subject('LP', Name1), failed_students_per_subject('LP', Failed1),
    write(Name1), write(' | '), write(Failed1), nl,
    subject('MTH', Name2), failed_students_per_subject('MTH', Failed2),
    write(Name2), write(' | '), write(Failed2), nl,
    subject('FP', Name3), failed_students_per_subject('FP', Failed3),
    write(Name3), write(' | '), write(Failed3), nl,
    subject('INF', Name4), failed_students_per_subject('INF', Failed4),
    write(Name4), write(' | '), write(Failed4), nl,
    subject('ENG', Name5), failed_students_per_subject('ENG', Failed5),
    write(Name5), write(' | '), write(Failed5), nl,
    subject('PSY', Name6), failed_students_per_subject('PSY', Failed6),
    write(Name6), write(' | '), write(Failed6), nl.

% 3. Найти количество не сдавших студентов в каждой из групп

has_failed_exams(Student) :-
    grade(Student, _, 2).

count_failed_in_group(Group, Count) :-
    findall(Student, 
            (student(Group, Student), has_failed_exams(Student)), 
            FailedStudents),
    sort(FailedStudents, UniqueFailed), 
    length(UniqueFailed, Count).

failed_by_groups_table :-
    write('Группа | Количество несдавших'), nl,
    write('---------------------------'), nl,
    count_failed_in_group(101, Count1),
    write('101     | '), write(Count1), nl,
    count_failed_in_group(102, Count2),
    write('102     | '), write(Count2), nl,
    count_failed_in_group(103, Count3),
    write('103     | '), write(Count3), nl,
    count_failed_in_group(104, Count4),
    write('104     | '), write(Count4), nl.